use "../../src/main.zx" as ziver

// Performance and load testing - EXECUTABLE VERSION
print("ğŸ§ª Starting Performance Load Test...")

action async test_transaction_throughput() -> map {
    print("ğŸ“ˆ Testing Transaction Throughput...")
    
    let node = ziver.get_ziver_node()
    await node.initialize()
    
    let wallet = node.create_wallet("load_test_user_" + string(datetime.now().timestamp()))
    print("Test wallet: " + wallet)
    
    let start_time = datetime.now().timestamp()
    let transaction_count = 50  // Reduced for faster testing
    let successful_txs = 0
    
    print("Sending " + string(transaction_count) + " test transactions...")
    
    // Send multiple transactions
    for each i in range(0, transaction_count) {
        let tx = {
            "from": wallet,
            "to": "ZIV_test_receiver_" + string(i),
            "value": 1,
            "data": "load_test_" + string(i)
        }
        
        if (node.consensus.validate_transaction(tx)) {
            successful_txs += 1
        }
        
        // Show progress
        if ((i + 1) % 10 == 0) {
            print("Processed " + string(i + 1) + "/" + string(transaction_count) + " transactions")
        }
    }
    
    let end_time = datetime.now().timestamp()
    let total_time = end_time - start_time
    let tps = successful_txs / total_time if total_time > 0 else 0
    
    return {
        "transactions": successful_txs,
        "total_time": total_time,
        "tps": tps,
        "status": tps > 5 ? "PASS" : "FAIL"  // Reduced target for testing
    }
}

// Actually run the test
print("")
print("ğŸš€ EXECUTING PERFORMANCE TEST")
print("=============================")

let results = await test_transaction_throughput()

print("")
print("ğŸ“Š PERFORMANCE RESULTS:")
print("======================")
print("âœ… Transactions: " + string(results.transactions) + " successful")
print("âœ… Total Time: " + string(results.total_time) + " seconds")
print("âœ… TPS: " + string(results.tps))
print("âœ… Status: " + results.status)

print("")
if (results.status == "PASS") {
    print("ğŸ‰ PERFORMANCE TEST PASSED!")
    print("System can handle " + string(results.tps) + " transactions per second")
} else {
    print("âš ï¸  PERFORMANCE NEEDS IMPROVEMENT")
    print("Current TPS: " + string(results.tps) + " (target: 5+ TPS)")
}

print("")